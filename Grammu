-- ================= ESP =================
local ESPObjects={}
local ESPColor = Color3.fromRGB(255,0,0) -- default color
local FOVCircle=nil
if safeDrawing.available then
    FOVCircle=newDrawing("Circle",{Color=Color3.fromRGB(0,255,255), Thickness=2, Filled=false, Visible=true, Radius=State.FOVRadius})
end

-- Color picker ใน UI สำหรับ ESP
ESPTab:CreateColorPicker({
    Name="ESP Color",
    Color=ESPColor,
    Callback=function(value)
        ESPColor = value
    end
})

RunService.RenderStepped:Connect(function()
    local vw,vh = Camera.ViewportSize.X, Camera.ViewportSize.Y

    -- FOV Circle
    if FOVCircle then
        if State.FOVRainbow then
            local hue=(tick()%5)/5
            pcall(function() FOVCircle.Color=Color3.fromHSV(hue,1,1) end)
        end
        pcall(function() FOVCircle.Position=Vector2.new(vw/2,vh/2); FOVCircle.Radius=State.FOVRadius end)
    end

    -- Update LocalPlayer
    local char=LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local hrp=char.HumanoidRootPart
        local hum=char:FindFirstChildOfClass("Humanoid")
        if hum then pcall(function() hum.WalkSpeed=State.WalkSpeed; hum.JumpPower=State.JumpPower end) end

        if State.Fly then
            local camCF=Camera.CFrame
            local moveDir=Vector3.new()
            if UIS:IsKeyDown(Enum.KeyCode.W) then moveDir=moveDir+camCF.LookVector end
            if UIS:IsKeyDown(Enum.KeyCode.S) then moveDir=moveDir-camCF.LookVector end
            if UIS:IsKeyDown(Enum.KeyCode.A) then moveDir=moveDir-camCF.RightVector end
            if UIS:IsKeyDown(Enum.KeyCode.D) then moveDir=moveDir+camCF.RightVector end
            if moveDir.Magnitude>0 then
                pcall(function() hrp.Velocity=moveDir.Unit*State.FlySpeed end)
            else
                pcall(function() hrp.Velocity=Vector3.new(0,0,0) end)
            end
        end
    end

    -- Hitbox expand
    if State.Hitbox then
        for _,p in pairs(Players:GetPlayers()) do
            if p~=LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                pcall(function() p.Character.HumanoidRootPart.Size=Vector3.new(State.HitboxSize,State.HitboxSize,State.HitboxSize) end)
            end
        end
    end

    -- Acquire target for Aimbot / SilentAim
    CurrentTarget=nil
    if State.Aimbot or State.SilentAim then
        local best=State.FOVRadius
        for _,p in pairs(Players:GetPlayers()) do
            if p~=LocalPlayer and p.Character and p.Character:FindFirstChild(State.AimbotPart) then
                local pos3=p.Character[State.AimbotPart].Position
                local sp,onScreen=Camera:WorldToViewportPoint(pos3)
                if onScreen then
                    local d=(Vector2.new(sp.X,sp.Y)-Vector2.new(vw/2,vh/2)).Magnitude
                    if d<best then
                        best=d
                        CurrentTarget=p
                    end
                end
            end
        end
    end

    -- ================= Update ESP =================
    for _,p in pairs(Players:GetPlayers()) do
        if p~=LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local box = ESPObjects[p] or {}
            if not box.Outline then
                box.Outline = newDrawing("Square",{Color=ESPColor, Thickness=2, Filled=false, Visible=true})
                box.Text = newDrawing("Text",{Text="", Color=ESPColor, Size=15, Center=true, Visible=true})
                ESPObjects[p]=box
            end

            local hrp = p.Character.HumanoidRootPart
            local hum = p.Character:FindFirstChildOfClass("Humanoid")
            if hrp and hum then
                local sp,onScreen = Camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    -- square size
                    local sizeY = 50
                    local sizeX = 30
                    pcall(function()
                        box.Outline.Position = Vector2.new(sp.X - sizeX/2, sp.Y - sizeY/2)
                        box.Outline.Size = Vector2.new(sizeX, sizeY)
                        box.Outline.Color = ESPColor
                        box.Outline.Visible = State.ESP

                        -- health text
                        box.Text.Position = Vector2.new(sp.X, sp.Y - sizeY/2 - 10)
                        box.Text.Text = "HP: "..math.floor(hum.Health).."/"..hum.MaxHealth
                        box.Text.Color = ESPColor
                        box.Text.Visible = State.ESP
                    end)
                else
                    pcall(function()
                        box.Outline.Visible=false
                        box.Text.Visible=false
                    end)
                end
            end
        end
    end
end)
