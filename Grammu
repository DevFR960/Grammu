-- COCO HUB MM2 FULL (Fixed + WalkSpeed + High Jump + ESP + Aimbot + SilentAim + Team Tags)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Plr = Players.LocalPlayer
local Camera = workspace.CurrentCamera
repeat task.wait() until Plr and Plr.Character and Plr.Character:FindFirstChild("HumanoidRootPart")

-- Load Rayfield UI
local success, Rayfield = pcall(function()
    return loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
end)
if not success or not Rayfield then return warn("‚ùå Failed to load Rayfield UI") end

-- Variables
local ESPEnabled, aimbotEnabled, silentAimEnabled, TeamTagEnabled = false, false, false, false
local walkSpeed, highJump = 16, false
local fov, silentFOV = 100, 120
local aimbotLockPart, silentLockPart = "Head", "Head"
local fovCircle, silentCircle, silentTarget = nil, nil, nil
local TeamTags, playerAddedConnection, playerRemovingConnection = {}, nil, nil
local humanoid = nil

-- Character Respawn Support
local function updateStats()
    if Plr.Character then
        humanoid = Plr.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = walkSpeed
            humanoid.JumpPower = highJump and 100 or 50
        end
    end
end

Plr.CharacterAdded:Connect(function()
    repeat task.wait() until Plr.Character and Plr.Character:FindFirstChildOfClass("Humanoid")
    updateStats()
end)

-- Team tag
local function getTeam(p)
    local ls = p:FindFirstChild("leaderstats")
    local tv = ls and ls:FindFirstChild("Team")
    return (tv and tv:IsA("StringValue")) and tv.Value or "No Team"
end

local function createTeamTag(p)
    if not p.Character or not p.Character:FindFirstChild("Head") then return end
    local head = p.Character.Head
    if head:FindFirstChild("TeamTagGui") then head.TeamTagGui:Destroy() end

    local gui = Instance.new("BillboardGui", head)
    gui.Name = "TeamTagGui"
    gui.Size = UDim2.new(0,100,0,30)
    gui.StudsOffset = Vector3.new(0,2.5,0)
    gui.AlwaysOnTop = true
    gui.Adornee = head

    local label = Instance.new("TextLabel", gui)
    label.Size = UDim2.fromScale(1,1)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.Font = Enum.Font.SourceSansBold
    label.TextStrokeTransparency = 0

    if TeamTags[p] then task.cancel(TeamTags[p]) end
    TeamTags[p] = task.spawn(function()
        while TeamTagEnabled and p.Parent do
            local t = getTeam(p)
            label.Text = t
            label.TextColor3 = (t=="Innocent" and Color3.new(0,1,0)) or (t=="Sheriff" and Color3.new(0,0,1)) or (t=="Murderer" and Color3.new(1,0,0)) or Color3.new(1,1,1)
            task.wait(0.5)
        end
        gui:Destroy()
    end)
end

local function removeTeamTag(p)
    if TeamTags[p] then task.cancel(TeamTags[p]); TeamTags[p] = nil end
    if p.Character and p.Character:FindFirstChild("TeamTagGui") then
        p.Character.TeamTagGui:Destroy()
    end
end

local function refreshTeamTags(state)
    TeamTagEnabled = state
    if playerAddedConnection then playerAddedConnection:Disconnect() end
    if playerRemovingConnection then playerRemovingConnection:Disconnect() end

    if state then
        for _,p in pairs(Players:GetPlayers()) do
            if p ~= Plr then createTeamTag(p) end
        end
        playerAddedConnection = Players.PlayerAdded:Connect(function(p)
            if TeamTagEnabled then
                p.CharacterAdded:Connect(function()
                    task.wait(1)
                    createTeamTag(p)
                end)
            end
        end)
        playerRemovingConnection = Players.PlayerRemoving:Connect(removeTeamTag)
    else
        for _,p in pairs(Players:GetPlayers()) do
            removeTeamTag(p)
        end
    end
end

-- Utility: Find closest target
local function findClosestTarget(radius, lockPart)
    local bestDist, bestPart = math.huge, nil
    for _,p in pairs(Players:GetPlayers()) do
        if p~=Plr and p.Character and p.Character:FindFirstChild(lockPart) then
            local part = p.Character[lockPart]
            local pos,on = Camera:WorldToViewportPoint(part.Position)
            if on then
                local dist = (Vector2.new(pos.X,pos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if dist < radius and dist < bestDist then
                    bestDist, bestPart = dist, part
                end
            end
        end
    end
    return bestPart
end

-- Hook for SilentAim
local oldNamecall
if hookmetamethod then
    oldNamecall = hookmetamethod(game, "__namecall", function(self,...)
        local method = getnamecallmethod()
        local args = {...}
        if method=="FireServer" and tostring(self)=="Shoot" and silentAimEnabled and silentTarget and typeof(args[1])=="Vector3" then
            args[1] = silentTarget.Position + Vector3.new(0,1.5,0)
            return oldNamecall(self, unpack(args))
        end
        return oldNamecall(self, ...)
    end)
end

-- Rayfield UI
local Window = Rayfield:CreateWindow({Name="COCO HUB"})
local MainTab = Window:CreateTab("Main")

-- ESP Toggle
MainTab:CreateToggle({
    Name = "ESP",
    CurrentValue = ESPEnabled,
    Callback = function(state)
        ESPEnabled = state
        if state then
            task.spawn(function()
                while ESPEnabled do
                    task.wait(0.5)
                    for _,p in ipairs(Players:GetPlayers()) do
                        if p~=Plr and p.Character and not p.Character:FindFirstChild("ESP") then
                            local hl = Instance.new("Highlight", p.Character)
                            hl.Name = "ESP"
                            hl.FillColor = Color3.new(0,1,0)
                            hl.OutlineColor = Color3.new(1,1,0)
                            hl.FillTransparency = 0.5
                        end
                    end
                end
                for _,p in ipairs(Players:GetPlayers()) do
                    if p.Character and p.Character:FindFirstChild("ESP") then
                        p.Character.ESP:Destroy()
                    end
                end
            end)
        else
            for _,p in ipairs(Players:GetPlayers()) do
                if p.Character and p.Character:FindFirstChild("ESP") then
                    p.Character.ESP:Destroy()
                end
            end
        end
    end
})

-- WalkSpeed + HighJump Controls
MainTab:CreateSlider({
    Name="WalkSpeed", Range={16,100}, Increment=1, CurrentValue=walkSpeed,
    Callback=function(val)
        walkSpeed = val
        if humanoid then humanoid.WalkSpeed = val end
    end
})
MainTab:CreateToggle({
    Name="Enable WalkSpeed", CurrentValue=false,
    Callback=function(state)
        if humanoid then humanoid.WalkSpeed = state and walkSpeed or 16 end
    end
})
MainTab:CreateToggle({
    Name="High Jump", CurrentValue=highJump,
    Callback=function(state)
        highJump = state
        updateStats()
    end
})

-- Aimbot Controls
MainTab:CreateDropdown({Name="Aimbot Lock To", Options={"Head","HumanoidRootPart"}, CurrentOption=aimbotLockPart, Callback=function(val) aimbotLockPart=val end})
MainTab:CreateToggle({
    Name="Aimbot", CurrentValue=aimbotEnabled,
    Callback=function(state)
        aimbotEnabled = state
        if fovCircle then fovCircle:Remove() end
        if state then
            fovCircle = Drawing.new("Circle")
            fovCircle.Radius = fov; fovCircle.Thickness=2; fovCircle.Transparency=0.5; fovCircle.Filled=false; fovCircle.Visible=true
            task.spawn(function()
                while aimbotEnabled do
                    task.wait()
                    fovCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
                    fovCircle.Color = Color3.fromHSV((tick()%5)/5,1,1)
                    local target = findClosestTarget(fov, aimbotLockPart)
                    if target then
                        Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Position)
                    end
                end
                if fovCircle then fovCircle:Remove() end
            end)
        end
    end
})
MainTab:CreateSlider({Name="Aimbot FOV", Range={100,500}, Increment=10, CurrentValue=fov, Callback=function(val) fov=val if fovCircle then fovCircle.Radius=val end end})

-- Silent Aim Controls
MainTab:CreateDropdown({Name="Silent Aim Lock To", Options={"Head","HumanoidRootPart"}, CurrentOption=silentLockPart, Callback=function(val) silentLockPart=val end})
MainTab:CreateToggle({
    Name="Silent Aim", CurrentValue=silentAimEnabled,
    Callback=function(state)
        silentAimEnabled = state
        if silentCircle then silentCircle:Remove() end
        if state then
            silentCircle = Drawing.new("Circle")
            silentCircle.Radius=silentFOV; silentCircle.Thickness=2; silentCircle.Transparency=0.5; silentCircle.Filled=false; silentCircle.Visible=true
            task.spawn(function()
                while silentAimEnabled do
                    task.wait()
                    silentCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
                    silentCircle.Color = Color3.fromHSV((tick()%5)/5,1,1)
                    silentTarget = findClosestTarget(silentFOV, silentLockPart)
                end
                if silentCircle then silentCircle:Remove() end
            end)
        end
    end
})
MainTab:CreateSlider({Name="Silent Aim FOV", Range={50,500}, Increment=10, CurrentValue=silentFOV, Callback=function(val) silentFOV=val if silentCircle then silentCircle.Radius=val end end})

-- Team Tag Toggle
MainTab:CreateToggle({Name="Team Tags", CurrentValue=TeamTagEnabled, Callback=refreshTeamTags})

-- Unload Button
MainTab:CreateButton({
    Name="Unload COCO HUB",
    Callback=function()
        if fovCircle then fovCircle:Remove() end
        if silentCircle then silentCircle:Remove() end
        refreshTeamTags(false)
        for _,p in ipairs(Players:GetPlayers()) do
            if p.Character and p.Character:FindFirstChild("ESP") then
                p.Character.ESP:Destroy()
            end
        end
        if humanoid then
            humanoid.WalkSpeed=16; humanoid.JumpPower=50
        end
        ESPEnabled = aimbotEnabled = silentAimEnabled = TeamTagEnabled = highJump = false
        print("[COCO HUB] Unloaded.")
    end
})

print("[COCO HUB] Fully Loaded!")
