-- COCO HUB MM2 Full Script
-- Features: Key System, WalkSpeed, HighJump, Aimbot (Head), Silent Aim, ESP, Team Tags (from Role), Rayfield UI
-- Key: "Flower"

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Key System (simple TextBox)
local correctKey = "Flower"
local function promptKey()
    local CoreGui = game:GetService("CoreGui")
    local screen = Instance.new("ScreenGui")
    screen.Name = "KeySystem"
    screen.Parent = CoreGui

    local box = Instance.new("TextBox")
    box.Size = UDim2.new(0, 200, 0, 50)
    box.Position = UDim2.new(0.5, -100, 0.5, -25)
    box.PlaceholderText = "Enter Key"
    box.TextScaled = true
    box.Parent = screen

    local confirmed = false
    box.FocusLost:Connect(function(enter)
        if enter and box.Text == correctKey then
            screen:Destroy()
            confirmed = true
        else
            box.Text = ""
            box.PlaceholderText = "Incorrect! Try again."
        end
    end)
    repeat task.wait() until confirmed
end
promptKey()

-- Load Rayfield UI (you need to do the loadstring in your executor)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "ðŸŒˆ COCO HUB - MM2",
    LoadingTitle = "COCO HUB",
    LoadingSubtitle = "by DevFR960",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false,
})

-- Variables
local walkSpeed = 16
local jumpPower = 50
local walkSpeedEnabled = false
local highJumpEnabled = false
local aimbotEnabled = false
local silentAimEnabled = false
local espEnabled = false

local LockPart = "Head" -- Aimbot lock to head
local silentTarget = nil
local espHighlights = {}
local teamTags = {}

-- Utility function to get player role from player object
local function getPlayerRole(player)
    local roleValue = player:FindFirstChild("Role") or player:FindFirstChild("MM2Role")
    if roleValue and roleValue:IsA("StringValue") then
        return roleValue.Value
    end
    return "Unknown"
end

-- Function to create team tag billboard
local function createTeamTag(player)
    if not player.Character or not player.Character:FindFirstChild("Head") then return end
    if teamTags[player] then return end

    local tag = Instance.new("BillboardGui")
    tag.Name = "TeamTag"
    tag.Adornee = player.Character.Head
    tag.Size = UDim2.new(0, 100, 0, 35)
    tag.StudsOffset = Vector3.new(0, 2.5, 0)
    tag.AlwaysOnTop = true

    local label = Instance.new("TextLabel", tag)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextScaled = true

    local role = getPlayerRole(player)
    label.Text = role

    if role == "Sheriff" then
        label.TextColor3 = Color3.fromRGB(0, 255, 255) -- Cyan
    elseif role == "Murderer" then
        label.TextColor3 = Color3.fromRGB(255, 0, 0) -- Red
    elseif role == "Innocent" then
        label.TextColor3 = Color3.fromRGB(255, 255, 255) -- White
    else
        label.TextColor3 = Color3.fromRGB(255, 255, 0) -- Yellow for unknown
    end

    tag.Parent = player.Character.Head
    teamTags[player] = tag
end

-- Remove all team tags
local function clearTeamTags()
    for player, tag in pairs(teamTags) do
        if tag and tag.Parent then
            tag:Destroy()
        end
    end
    teamTags = {}
end

-- Get closest target to mouse for aimbot and silent aim
local function getClosestTarget()
    local closestPlayer = nil
    local shortestDistance = math.huge
    local mousePos = UserInputService:GetMouseLocation()

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(LockPart) then
            local headPos, onScreen = Camera:WorldToViewportPoint(player.Character[LockPart].Position)
            if onScreen then
                local screenPos = Vector2.new(headPos.X, headPos.Y)
                local dist = (screenPos - mousePos).Magnitude
                if dist < shortestDistance then
                    shortestDistance = dist
                    closestPlayer = player
                end
            end
        end
    end
    return closestPlayer
end

-- UI Setup

local MainTab = Window:CreateTab("Main", 4483362458)

MainTab:CreateToggle({
    Name = "Enable WalkSpeed",
    CurrentValue = false,
    Flag = "WalkSpeedToggle",
    Callback = function(state)
        walkSpeedEnabled = state
        if not state and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = 16
        end
    end,
})

MainTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {16, 200},
    Increment = 1,
    CurrentValue = walkSpeed,
    Flag = "WalkSpeedValue",
    Callback = function(value)
        walkSpeed = value
        if walkSpeedEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = value
        end
    end,
})

MainTab:CreateToggle({
    Name = "Enable High Jump",
    CurrentValue = false,
    Flag = "HighJumpToggle",
    Callback = function(state)
        highJumpEnabled = state
        if not state and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = 50
        end
    end,
})

MainTab:CreateSlider({
    Name = "Jump Power",
    Range = {50, 200},
    Increment = 1,
    CurrentValue = jumpPower,
    Flag = "JumpPowerValue",
    Callback = function(value)
        jumpPower = value
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = value
        end
    end,
})

MainTab:CreateToggle({
    Name = "Enable Aimbot",
    CurrentValue = false,
    Flag = "AimbotToggle",
    Callback = function(state)
        aimbotEnabled = state
    end,
})

MainTab:CreateToggle({
    Name = "Enable Silent Aim",
    CurrentValue = false,
    Flag = "SilentAimToggle",
    Callback = function(state)
        silentAimEnabled = state
    end,
})

MainTab:CreateToggle({
    Name = "Enable ESP Highlight",
    CurrentValue = false,
    Flag = "ESPToggle",
    Callback = function(state)
        espEnabled = state
        if not state then
            for _, hl in pairs(espHighlights) do
                if hl and hl.Parent then
                    hl:Destroy()
                end
            end
            espHighlights = {}
        end
    end,
})

MainTab:CreateToggle({
    Name = "Show Team Tags",
    CurrentValue = false,
    Flag = "TeamTagToggle",
    Callback = function(state)
        if state then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    createTeamTag(player)
                end
            end
        else
            clearTeamTags()
        end
    end,
})

-- Connect Player Added and Removing for Team Tags update
Players.PlayerAdded:Connect(function(player)
    if espEnabled or (Window.Flags["TeamTagToggle"] and Window.Flags["TeamTagToggle"].Value) then
        createTeamTag(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    if teamTags[player] then
        teamTags[player]:Destroy()
        teamTags[player] = nil
    end
end)

-- Main loop
RunService.RenderStepped:Connect(function()
    local character = LocalPlayer.Character
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            if walkSpeedEnabled then
                humanoid.WalkSpeed = walkSpeed
            else
                humanoid.WalkSpeed = 16
            end

            if highJumpEnabled then
                humanoid.JumpPower = jumpPower
            else
                humanoid.JumpPower = 50
            end
        end
    end

    -- Aimbot lock camera to closest target head
    if aimbotEnabled then
        local target = getClosestTarget()
        if target and target.Character and target.Character:FindFirstChild(LockPart) then
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Character[LockPart].Position)
        end
    end

    -- ESP Highlight for all players when enabled
    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChildOfClass("Humanoid") and player.Character.Humanoid.Health > 0 then
                if not espHighlights[player] then
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = player.Character
                    highlight.FillColor = Color3.fromRGB(0, 255, 0)
                    highlight.FillTransparency = 0.6
                    highlight.OutlineTransparency = 0
                    highlight.Parent = player.Character
                    espHighlights[player] = highlight
                end
            elseif espHighlights[player] then
                espHighlights[player]:Destroy()
                espHighlights[player] = nil
            end
        end
    end
end)

-- Silent Aim Bullet Redirect Hook
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()
    if tostring(method) == "FireServer" and tostring(self.Name) == "Shoot" and silentAimEnabled and silentTarget then
        if typeof(args[1]) == "Vector3" then
            args[1] = silentTarget.Character[LockPart].Position + Vector3.new(0, 1.5, 0)
            return oldNamecall(self, unpack(args))
        end
    end
    return oldNamecall(self, ...)
end)

setreadonly(mt, true)

-- Update silentTarget each frame
RunService.RenderStepped:Connect(function()
    if silentAimEnabled then
        silentTarget = getClosestTarget()
    else
        silentTarget = nil
    end
end)

print("[âœ… COCO HUB MM2 Loaded Successfully]")
